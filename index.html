<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Form nhân viên — LC Foods</title>

<!-- flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
  :root{
    --brand:#e60012;
    --brand-2:#ff3344;
    --muted:#6b7280;
    --card:#fff;
    --bg:#f5f7f8;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:var(--bg);color:#111}
  .container{max-width:1100px;margin:18px auto;padding:18px}
  /* Header gradient LC Foods */
  .site-header{
    background: linear-gradient(90deg,var(--brand),var(--brand-2));
    color:#fff;padding:28px;border-radius:12px;display:flex;align-items:center;gap:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
  }
  .site-header .title{
    flex:1;text-align:center;font-weight:800;font-size:24px;letter-spacing:1px;
    text-shadow:0 2px 6px rgba(0,0,0,0.2);
  }
  .card{
    background:var(--card);border-radius:12px;padding:20px;margin-top:18px;
    box-shadow:0 8px 22px rgba(0,0,0,0.06);border:1px solid #eee;
  }
  .card-title{color:var(--brand);font-weight:800;margin-bottom:12px;font-size:16px}
  label{display:block;font-weight:700;color:var(--brand);margin-bottom:6px;font-size:13px}
  input[type=text], input[type=date], input[type=email], select, input[list]{
    width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;
    transition:box-shadow .12s,border-color .12s;
  }
  input:focus, select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 6px rgba(230,0,18,0.06)}
  .grid-row{display:flex;gap:16px;width:100%;align-items:center;flex-wrap:nowrap}
  .col-full{flex:1}
  .col-50{flex:0 0 50%}
  .col-40{flex:0 0 40%}
  .col-33{flex:0 0 33.333%}
  .col-30{flex:0 0 30%}
  .col-20{flex:0 0 20%}
  .col-15{flex:0 0 15%}
  .field{position:relative}
  .tooltip{position:absolute;left:0;bottom:-28px;background:var(--brand);color:#fff;padding:5px 8px;border-radius:6px;font-size:12px;z-index:10}
  .btn{background:var(--brand);color:#fff;padding:10px 26px;border-radius:999px;border:0;cursor:pointer;font-weight:800}
  .muted{color:var(--muted);font-size:13px}
  .form-footer{display:flex;justify-content:center;margin-top:18px}
  .success-popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1000}
  .success-inner{background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,0.2)}
  .border-red{border-color:var(--brand) !important}
  /* spinner */
  .spinner { border: 3px solid rgba(0,0,0,0.08); border-top: 3px solid var(--brand); border-radius: 50%; width: 18px; height: 18px; animation: spin 0.8s linear infinite; display:inline-block; vertical-align:middle; }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* combobox */
  .combobox { position: relative; }
  .combobox input[type="text"] { padding-right: 28px; }
  .combobox .clear-btn { position:absolute; right:6px; top:8px; background:transparent;border:0;cursor:pointer;font-weight:700;color:#999 }

  /* responsive */
  @media(max-width:900px){
    .grid-row{flex-direction:column;align-items:stretch;flex-wrap:wrap}
    .col-50,.col-40,.col-33,.col-30,.col-20,.col-15{flex:1 0 100%}
    .site-header{padding:20px}
    .site-header .title{font-size:20px}
  }
</style>
</head>
<body>

  <div class="container">
    <div class="site-header" role="banner" aria-label="LC Foods header">
      <div class="title">THÔNG TIN LÝ LỊCH CÁ NHÂN</div>
    </div>

    <form id="hrForm" class="form" autocomplete="off" novalidate>
      <!-- CARD 1: BASIC -->
      <div class="card">
        <div class="card-title">1. THÔNG TIN CƠ BẢN</div>

        <!-- Dòng 1: Mã NV – Họ đệm – Tên – Giới tính – Ngày sinh (B2) -->
        <div class="grid-row" style="margin-bottom:12px">
          <div class="field col-20">
            <label for="manv">Mã nhân viên *</label>
            <input id="manv" type="text" placeholder="VD: KD46404" required />
          </div>
          <div class="field col-25">
            <label for="hodem">Họ và tên đệm *</label>
            <input id="hodem" type="text" required />
          </div>
          <div class="field col-20">
            <label for="ten">Tên *</label>
            <input id="ten" type="text" required />
          </div>
          <div class="field col-15">
            <label for="gioitinh">Giới tính *</label>
            <select id="gioitinh" required>
              <option value="">-- Chọn --</option>
              <option>Nam</option>
              <option>Nữ</option>
              <option>Khác</option>
            </select>
          </div>
          <div class="field col-20">
            <label for="ngaysinh">Ngày sinh *</label>
            <input id="ngaysinh" type="text" class="flat-date" placeholder="dd/mm/yyyy" required />
          </div>
        </div>

        <!-- Dòng 2: CCCD – Ngày cấp – Nơi cấp -->
        <div class="grid-row" style="margin-bottom:12px">
          <div class="field col-33">
            <label for="cccd">Số CCCD *</label>
            <input id="cccd" type="text" inputmode="numeric" maxlength="12" required />
          </div>
          <div class="field col-33">
            <label for="ngaycap">Ngày cấp CCCD *</label>
            <input id="ngaycap" type="text" class="flat-date" placeholder="dd/mm/yyyy" required />
          </div>
          <div class="field col-33 combobox">
            <label for="noicap">Nơi cấp CCCD *</label>
            <input id="noicap" type="text" list="listNoiCap" placeholder="Gõ để tìm..." required />
            <datalist id="listNoiCap"></datalist>
            <button type="button" class="clear-btn" title="Xóa" style="display:none" aria-hidden>&times;</button>
          </div>
        </div>

        <input type="hidden" id="hoten" />
      </div>

      <!-- CARD 2: CÔNG VIỆC -->
      <div class="card">
        <div class="card-title">2. THÔNG TIN CÔNG VIỆC</div>

        <div class="grid-row" style="margin-bottom:12px">
          <div class="field col-33">
            <label for="nhanviec">Ngày nhận việc *</label>
            <input id="nhanviec" type="text" class="flat-date" placeholder="dd/mm/yyyy" required />
          </div>
          <div class="field col-33">
            <label for="nhanviechd">Ngày nhận việc theo HĐ</label>
            <input id="nhanviechd" type="text" class="flat-date" placeholder="dd/mm/yyyy" />
          </div>
          <div class="field col-33">
            <label for="chucvu">Chức vụ *</label>
            <select id="chucvu" required>
              <option value="">-- Chọn chức vụ --</option>
            </select>
          </div>
        </div>

        <div class="grid-row" style="margin-bottom:12px">
          <div class="field col-50">
            <label for="phongban">Phòng ban / Tổ *</label>
            <select id="phongban" required>
              <option value="">-- Chọn phòng ban --</option>
            </select>
          </div>
          <div class="field col-50">
            <label for="dienthoai">Điện thoại *</label>
            <input id="dienthoai" type="text" inputmode="tel" placeholder="10 số" required />
          </div>
        </div>

        <div class="grid-row" style="margin-bottom:6px">
          <div class="field col-50">
            <label for="email">Email *</label>
            <input id="email" type="text" placeholder="vd: a@b.com" required />
          </div>

          <div class="field col-50">
            <label>Tình trạng nhân viên</label>
            <input type="text" value="Đang làm việc" readonly />
          </div>
        </div>
      </div>

      <!-- CARD 3: ĐỊA CHỈ – HỘ KHẨU -->
      <div class="card">
        <div class="card-title">3. ĐỊA CHỈ – HỘ KHẨU</div>

        <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
          <div style="flex:1 1 200px">
            <label for="tinh">Tỉnh/TP</label>
            <select id="tinh"></select>
          </div>
          <div style="flex:1 1 200px">
            <label for="huyen">Quận/Huyện</label>
            <select id="huyen"></select>
          </div>

          <div style="flex:0 0 160px;display:flex;align-items:center;gap:8px">
            <input id="chkSapNhap" type="checkbox" />
            <label for="chkSapNhap" style="font-weight:600;color:var(--muted);">Đã sáp nhập (địa giới)</label>
          </div>
        </div>

        <div class="grid-row">
          <div class="field col-50">
            <label for="thuongtru">Địa chỉ thường trú</label>
            <input id="thuongtru" type="text" />
          </div>
          <div class="field col-50">
            <label for="tamtru">Địa chỉ tạm trú</label>
            <input id="tamtru" type="text" />
          </div>
        </div>
      </div>

      <!-- CARD 4: BHXH – THUẾ – HỌC VẤN -->
      <div class="card">
        <div class="card-title">4. BHXH – MÃ SỐ THUẾ – HỌC VẤN</div>
        <div class="grid-row" style="margin-bottom:12px">
          <div class="field col-33"><label for="mst">Mã số thuế</label><input id="mst" /></div>
          <div class="field col-33"><label for="bhxh">Mã số BHXH</label><input id="bhxh" /></div>
          <div class="field col-33"><label for="hocvan">Trình độ học vấn</label><input id="hocvan" /></div>
        </div>

        <div class="grid-row">
          <div class="field col-50"><label for="chuyenmon">Chuyên môn</label><input id="chuyenmon" /></div>
        </div>
      </div>

      <div class="form-footer">
        <button class="btn" id="submitBtn" type="submit">Gửi thông tin</button>
      </div>
    </form>

    <div class="success-popup" id="successPopup">
      <div class="success-inner">
        <div style="font-size:34px;color:#28a745">✓</div>
        <div style="margin-top:8px;font-weight:700">Gửi thành công!</div>
      </div>
    </div>
  </div>

<!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
(() => {
  const WORKER_URL = "https://nhanvien-form.dathongtan1810.workers.dev/";

  // elements
  const form = document.getElementById('hrForm');
  const manv = document.getElementById('manv');
  const hodem = document.getElementById('hodem');
  const ten = document.getElementById('ten');
  const hoten = document.getElementById('hoten');
  const gioitinh = document.getElementById('gioitinh');
  const cccd = document.getElementById('cccd');
  const ngaycap = document.getElementById('ngaycap');
  const noicap = document.getElementById('noicap');
  const ngaysinh = document.getElementById('ngaysinh');
  const nhanviec = document.getElementById('nhanviec');
  const nhanviechd = document.getElementById('nhanviechd');
  const chucvu = document.getElementById('chucvu');
  const phongban = document.getElementById('phongban');
  const dienthoai = document.getElementById('dienthoai');
  const email = document.getElementById('email');
  const tinh = document.getElementById('tinh');
  const huyen = document.getElementById('huyen');
  const chkSapNhap = document.getElementById('chkSapNhap');
  const submitBtn = document.getElementById('submitBtn');
  const successPopup = document.getElementById('successPopup');

  // flatpickr cho các trường ngày
  const flatOptions = { dateFormat: "d/m/Y", allowInput: true };
  document.querySelectorAll('.flat-date').forEach(el => flatpickr(el, flatOptions));

  // tooltip helpers
  function showTooltip(el, msg){
    if(!el || !el.parentElement) return;
    clearTooltip(el);
    const t = document.createElement('div');
    t.className='tooltip';
    t.innerText=msg;
    el.parentElement.appendChild(t);
    el.classList.add('border-red');
  }
  function clearTooltip(el){
    if(!el || !el.parentElement) return;
    const o = el.parentElement.querySelector('.tooltip');
    if(o) o.remove();
    el.classList.remove('border-red');
  }

  // Auto full name
  function updateHoten(){
    hoten.value = (hodem.value.trim() + ' ' + ten.value.trim()).trim();
  }
  hodem.addEventListener('input', updateHoten);
  ten.addEventListener('input', updateHoten);

  // Mã NV: A-Z0-9, uppercase
  manv.addEventListener('input', () => {
    const old = manv.value;
    const nu = old.toUpperCase().replace(/[^A-Z0-9]/g,'');
    if(old !== nu) manv.value = nu;
  });

  // CCCD: chỉ số, tối đa 12, validate 12 số
  cccd.addEventListener('input', () => {
    cccd.value = cccd.value.replace(/\D/g,'').slice(0,12);
    if(cccd.value && !/^\d{12}$/.test(cccd.value)) showTooltip(cccd, 'CCCD phải 12 chữ số');
    else clearTooltip(cccd);
  });

  // Điện thoại: 10 số, đầu 03/05/07/08/09
  dienthoai.addEventListener('input', () => {
    dienthoai.value = dienthoai.value.replace(/\D/g,'').slice(0,10);
    if(dienthoai.value && !/^(03|05|07|08|09)\d{8}$/.test(dienthoai.value)) {
      showTooltip(dienthoai,'SĐT phải 10 số, bắt đầu 03/05/07/08/09');
    } else clearTooltip(dienthoai);
  });

  // Email basic validate
  email.addEventListener('input', () => {
    const v = email.value.trim();
    const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    if(v && !ok) showTooltip(email,'Email không đúng định dạng');
    else clearTooltip(email);
  });

  // ENTER: không submit, không mất dữ liệu, nhảy sang ô tiếp theo
  const inputs = Array.from(form.querySelectorAll('input,select')).filter(i=>i.type!=='hidden');
  inputs.forEach((el, idx) => {
    el.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        try {
          if(el._flatpickr && el._flatpickr.isOpen){
            el._flatpickr.close();
          }
        } catch(e){}
        try { el.blur(); } catch(e){}
        let next = null;
        for(let i = idx+1; i<inputs.length; i++){
          const cand = inputs[i];
          if(!cand.disabled && cand.offsetParent !== null){
            next = cand; break;
          }
        }
        if(next) next.focus(); else submitBtn.focus();
      }
    });
  });

  // Danh mục chức vụ / phòng ban (mẫu)
  const defaultChucVu = [
    "Nhân viên", "Trưởng nhóm", "Quản lý", "Giám sát", "Nhân viên kỹ thuật", "Nhân viên bán hàng"
  ];
  const defaultPhongBan = [
    "Sản xuất", "Kinh doanh", "Hành chính", "Nhân sự", "Kho", "IT", "Chất lượng"
  ];
  defaultChucVu.forEach(x => {
    const o = document.createElement('option'); o.value = x; o.textContent = x; chucvu.appendChild(o);
  });
  defaultPhongBan.forEach(x => {
    const o = document.createElement('option'); o.value = x; o.textContent = x; phongban.appendChild(o);
  });

  // Danh mục tỉnh / TP
  const provinces = [
    "Hà Nội","Hồ Chí Minh","Hải Phòng","Đà Nẵng","Cần Thơ","An Giang","Bà Rịa - Vũng Tàu","Bắc Giang",
    "Bắc Kạn","Bạc Liêu","Bắc Ninh","Bến Tre","Bình Định","Bình Dương","Bình Phước","Bình Thuận",
    "Cà Mau","Đắk Lắk","Đắk Nông","Điện Biên","Đồng Nai","Đồng Tháp","Gia Lai","Hà Giang","Hà Nam",
    "Hà Tĩnh","Hải Dương","Hậu Giang","Hòa Bình","Hưng Yên","Khánh Hòa","Kiên Giang","Kon Tum",
    "Lai Châu","Lâm Đồng","Lạng Sơn","Lào Cai","Long An","Nam Định","Nghệ An","Ninh Bình","Ninh Thuận",
    "Phú Thọ","Phú Yên","Quảng Bình","Quảng Nam","Quảng Ngãi","Quảng Ninh","Quảng Trị","Sóc Trăng",
    "Sơn La","Tây Ninh","Thái Bình","Thái Nguyên","Thanh Hóa","Thừa Thiên Huế","Tiền Giang","Trà Vinh",
    "Tuyên Quang","Vĩnh Long","Vĩnh Phúc","Yên Bái"
  ];

  const districtsMap = {
    "Hà Nội":["Quận Ba Đình","Quận Hoàn Kiếm","Quận Đống Đa","Quận Hai Bà Trưng","Quận Tây Hồ","Quận Cầu Giấy","Quận Thanh Xuân","Huyện Đông Anh","Huyện Sóc Sơn"],
    "Hồ Chí Minh":["Quận 1","Quận 3","Quận 4","Quận 5","Quận 7","Quận Bình Thạnh","Huyện Nhà Bè","Huyện Bình Chánh","Thành Phố Thủ Đức"],
    "Đồng Nai":["TP Biên Hòa","Huyện Long Thành","Huyện Nhơn Trạch"],
    "Bình Dương":["TP Thủ Dầu Một","TP Dĩ An","TP Thuận An"],
    "Hải Phòng":["Quận Hồng Bàng","Quận Ngô Quyền","Quận Lê Chân"],
    "Đà Nẵng":["Quận Hải Châu","Quận Sơn Trà","Quận Thanh Khê"]
  };

  function populateProvinces(initial = false){
    if(!tinh.options.length){
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '-- Chọn tỉnh/TP --';
      tinh.appendChild(placeholder);
      provinces.forEach(p => {
        const o = document.createElement('option'); o.value=p; o.textContent=p; tinh.appendChild(o);
      });
    }
    if(initial){
      tinh.selectedIndex = 0;
      const firstProv = provinces[0];
      populateDistrictsFor(firstProv);
      tinh.value = firstProv;
    }
  }

  function populateDistrictsFor(prov){
    huyen.innerHTML = '';
    if(!prov){
      const pl = document.createElement('option');
      pl.value=''; pl.textContent='-- Chọn quận/huyện --';
      huyen.appendChild(pl);
      return;
    }
    const list = districtsMap[prov] || [`Quận/Huyện của ${prov}`];
    list.forEach(x => {
      const o = document.createElement('option'); o.value=x; o.textContent=x; huyen.appendChild(o);
    });
  }

  populateProvinces(true);

  tinh.addEventListener('change', (e) => {
    populateDistrictsFor(e.target.value);
  });

  // datalist nơi cấp
  const noiCapList = [
    "Công an TP Hồ Chí Minh","Công an Hà Nội","Công an Đồng Nai","Công an Bình Dương","Công an Hải Phòng",
    "Công an Đà Nẵng","Công an Cần Thơ","Cục Cảnh sát QLHC về TTXH","Công an Long An","Công an Bình Thuận"
  ];
  const listNoiCap = document.getElementById('listNoiCap');
  noiCapList.forEach(x => {
    const opt = document.createElement('option'); opt.value = x; listNoiCap.appendChild(opt);
  });

  // clear button cho combobox nơi cấp
  document.querySelectorAll('.combobox').forEach(cb => {
    const input = cb.querySelector('input[list]');
    const btn = cb.querySelector('.clear-btn');
    if(!input || !btn) return;
    input.addEventListener('input', () => btn.style.display = input.value ? 'inline' : 'none');
    btn.addEventListener('click', () => { input.value=''; input.focus(); btn.style.display='none'; });
  });

  // "Đã sáp nhập" chỉ ảnh hưởng tới hiển thị địa giới (không ảnh hưởng trạng thái nhân viên)
  chkSapNhap.addEventListener('change', () => {
    if(chkSapNhap.checked){
      huyen.disabled = true;
    } else {
      huyen.disabled = false;
    }
  });

  function formatDateStringFromFlatpickr(value){
    return value || '';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // clear tooltip cũ
    form.querySelectorAll('.tooltip').forEach(t => t.remove());
    [manv, hodem, ten, gioitinh, cccd, ngaycap, noicap, ngaysinh, nhanviec, dienthoai, email].forEach(el => el && el.classList.remove('border-red'));

    // check bắt buộc
    const requiredFields = [manv, hodem, ten, gioitinh, cccd, ngaycap, noicap, ngaysinh, nhanviec, dienthoai, email];
    for(const f of requiredFields){
      if(!f || !f.value || f.value.trim() === ''){
        showTooltip(f, 'Không được để trống');
        f.focus();
        return;
      }
    }

    // validate mã NV
    if(!/^[A-Z0-9]+$/.test(manv.value.trim())){
      showTooltip(manv, 'Mã NV chỉ chữ và số (in hoa, không dấu)');
      manv.focus(); return;
    }

    // validate CCCD
    if(!/^\d{12}$/.test(cccd.value.trim())){
      showTooltip(cccd, 'CCCD phải gồm đúng 12 chữ số');
      cccd.focus(); return;
    }

    // validate SĐT
    if(!/^(03|05|07|08|09)\d{8}$/.test(dienthoai.value.trim())){
      showTooltip(dienthoai, 'SĐT phải 10 số, bắt đầu 03/05/07/08/09');
      dienthoai.focus(); return;
    }

    // validate email
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value.trim())){
      showTooltip(email, 'Email không đúng định dạng');
      email.focus(); return;
    }

    // build payload
    updateHoten();
    const payload = {
      manv: manv.value.trim(),
      hodem: hodem.value.trim(),
      ten: ten.value.trim(),
      hoten: hoten.value.trim(),
      gioitinh: gioitinh.value || '',
      cccd: "'" + cccd.value.trim(), // giữ số 0 đầu trong Google Sheets
      ngaycap: formatDateStringFromFlatpickr(ngaycap.value),
      noicap: noicap.value.trim(),
      ngaysinh: formatDateStringFromFlatpickr(ngaysinh.value),
      nhanviec: formatDateStringFromFlatpickr(nhanviec.value),
      nhanviechd: formatDateStringFromFlatpickr(nhanviechd.value),
      chucvu: chucvu.value || '',
      phongban: phongban.value || '',
      dienthoai: dienthoai.value.trim(),
      email: email.value.trim(),
      tinh: tinh.value || '',
      huyen: huyen.value || '',
      tinhtrang: "Đang làm việc", // luôn cố định theo lựa chọn A
      thuongtru: document.getElementById('thuongtru').value || '',
      tamtru: document.getElementById('tamtru').value || '',
      mst: document.getElementById('mst').value || '',
      bhxh: document.getElementById('bhxh').value || '',
      hocvan: document.getElementById('hocvan').value || '',
      chuyenmon: document.getElementById('chuyenmon').value || '',
      submittedAt: new Date().toISOString()
    };

    // gửi Worker
    submitBtn.disabled = true;
    const old = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner"></span>';

    try {
      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch(e){ json = {status: res.ok ? 'success' : 'error'}; }

      if(!res.ok || (json && json.status && json.status !== 'success')){
        alert('Lỗi gửi:\n' + text);
        submitBtn.disabled = false;
        submitBtn.innerHTML = old;
        return;
      }

      successPopup.style.display = 'flex';
      setTimeout(()=> successPopup.style.display = 'none', 1600);

      form.reset();
      populateProvinces(true); // reset tỉnh/huyện
    } catch(err){
      alert('Lỗi mạng: ' + (err && err.message ? err.message : err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = old;
    }
  });

})();
</script>

</body>
</html>
