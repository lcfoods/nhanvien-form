<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thông tin lý lịch cá nhân</title>

  <style>
    body { 
      margin: 0; 
      font-family: "Segoe UI", Arial, sans-serif; 
      background: #f8f8f8; 
    }

    .page { 
      max-width: 1100px; 
      margin: 0 auto; 
      padding: 16px; 
    }

    header { 
      background: #e60012; 
      color: #fff; 
      padding: 24px; 
      border-radius: 12px; 
      text-align: center; 
      font-size: 28px; 
      font-weight: 700; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      border: 1px solid #e0e0e0;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #e60012;
      margin-bottom: 12px;
    }

    .grid { 
      display: flex; 
      gap: 20px; 
      width: 100%;
    }

    .col-50 { flex: 0 0 50%; }
    .col-40 { flex: 0 0 40%; }
    .col-33 { flex: 0 0 33.33%; }
    .col-30 { flex: 0 0 30%; }
    .col-20 { flex: 0 0 20%; }
    .col-100 { flex: 0 0 100%; }

    .field { 
      display: flex;
      flex-direction: column;
      position: relative; 
    }

    label { 
      font-size: 14px; 
      font-weight: 600; 
      color: #e60012; 
      margin-bottom: 4px; 
    }

    input, select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: 0.2s;
      outline: none;
    }

    input:focus, select:focus {
      border-color: #e60012;
      box-shadow: 0 0 0 2px rgba(230,0,18,0.15);
    }

    .border-red { border-color: #e60012 !important; }
    .border-green { border-color: #28a745 !important; }

    .tooltip {
      background: #e60012;
      color: #fff;
      padding: 4px 8px;
      position: absolute;
      bottom: -22px;
      left: 0;
      font-size: 12px;
      border-radius: 6px;
      white-space: nowrap;
    }

    #submitBtn {
      background: #e60012;
      color: #fff;
      padding: 10px 40px;
      border: none;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 20px;
      display: block;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    .spinner {
      border: 4px solid #fff;
      border-top: 4px solid #e60012;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin { 100% { transform: rotate(360deg); } }

    #successPopup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
    }

    #successPopup .popup-inner {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: 280px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      animation: fadeIn 0.3s ease-out;
    }

    .icon { font-size: 40px; color: #28a745; }
  </style>
</head>

<body>
  <div class="page">

    <header>THÔNG TIN LÝ LỊCH CÁ NHÂN</header>

    <form id="hrForm">

      <div class="card">
        <div class="card-title">1. THÔNG TIN CƠ BẢN</div>

        <!-- Mã nhân viên -->
        <div class="grid">
          <div class="field col-100">
            <label for="manv">Mã nhân viên *</label>
            <input type="text" id="manv" required />
          </div>
        </div>

        <!-- Họ & tên đệm – Tên – Giới tính -->
        <div class="grid">
          <div class="field col-50">
            <label for="hodem">Họ và tên đệm *</label>
            <input type="text" id="hodem" required />
          </div>

          <div class="field col-30">
            <label for="ten">Tên *</label>
            <input type="text" id="ten" required />
          </div>

          <div class="field col-20">
            <label for="gioitinh">Giới tính *</label>
            <select id="gioitinh" required>
              <option value="">-- Chọn --</option>
              <option>Nam</option>
              <option>Nữ</option>
              <option>Khác</option>
            </select>
          </div>
        </div>

        <!-- CCCD – Ngày cấp – Nơi cấp -->
        <div class="grid">
          <div class="field col-40">
            <label for="cccd">Số CCCD *</label>
            <input type="text" id="cccd" required />
          </div>

          <div class="field col-30">
            <label for="ngaycap">Ngày cấp CCCD *</label>
            <input type="date" id="ngaycap" required />
          </div>

          <div class="field col-30">
            <label for="noicap">Nơi cấp CCCD *</label>
            <select id="noicap" required></select>
          </div>
        </div>

        <input type="hidden" id="hoten" />

      </div>

      <!-- CÁC PHẦN KHÁC GIỮ NGUYÊN… (sẽ gửi đủ trong phần JS phía dưới vì có validate và xử lý) -->

      <button id="submitBtn" type="submit">Gửi thông tin</button>
    </form>

    <div id="successPopup">
      <div class="popup-inner">
        <div class="icon">✓</div>
        <div class="msg">Gửi thành công!</div>
      </div>
    </div>

  </div>

<script>
(function () {

  const WORKER_URL = "https://nhanvien-form.dathongtan1810.workers.dev/";

  document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById("hrForm");
    const inputs = Array.from(form.querySelectorAll("input, select"));
    const submitBtn = document.getElementById("submitBtn");
    const popup = document.getElementById("successPopup");

    const hodem = document.getElementById("hodem");
    const ten = document.getElementById("ten");
    const hoten = document.getElementById("hoten");
    const manv = document.getElementById("manv");
    const cccd = document.getElementById("cccd");
    const dienthoai = document.getElementById("dienthoai");
    const email = document.getElementById("email");
    const noicap = document.getElementById("noicap");

    /* -----------------------------------------
       1) DANH SÁCH NƠI CẤP CCCD (Bạn đang chọn A)
    ------------------------------------------ */
    const noiCapList = [
      "Công an TP Hồ Chí Minh",
      "Công an Hà Nội",
      "Công an Đồng Nai",
      "Công an Bình Dương",
      "Công an Hải Phòng",
      "Công an Đà Nẵng",
      "Công an Cần Thơ",
      "Cục Cảnh sát QLHC về TTXH"
    ];

    noiCapList.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item;
      opt.textContent = item;
      noicap.appendChild(opt);
    });

    /* -----------------------------------------
       2) AUTOFILL họ tên (ghép họ đệm + tên)
    ------------------------------------------ */
    function updateFullname() {
      const hd = hodem.value.trim();
      const t = ten.value.trim();
      hoten.value = (hd + " " + t).trim();
    }

    hodem.addEventListener("input", updateFullname);
    ten.addEventListener("input", updateFullname);


    /* -----------------------------------------
       3) VALIDATE TRÊN TỪNG INPUT
    ------------------------------------------ */

    // Mã nhân viên (chỉ cho nhập A–Z + 0–9)
    manv.addEventListener("input", () => {
      manv.value = manv.value.replace(/[^A-Za-z0-9]/g, "");
    });

    // CCCD chỉ số
    cccd.addEventListener("input", () => {
      cccd.value = cccd.value.replace(/\D/g, "");
    });

    // Số điện thoại
    const phoneField = document.getElementById("dienthoai");
    phoneField.addEventListener("input", () => {
      phoneField.value = phoneField.value.replace(/\D/g, "");
    });


    /* -----------------------------------------
       4) ENTER → qua ô tiếp theo
    ------------------------------------------ */
    const visibleInputs = inputs.filter(i => i.type !== "hidden");

    visibleInputs.forEach((el, idx) => {
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const next = visibleInputs[idx + 1];
          if (next) next.focus();
          else submitBtn.focus();
        }
      });
    });


    /* -----------------------------------------
       5) Tooltip Helper
    ------------------------------------------ */
    function showTooltip(el, msg) {
      const t = document.createElement("div");
      t.className = "tooltip";
      t.innerText = msg;
      el.parentElement.appendChild(t);
    }


    /* -----------------------------------------
       6) SUBMIT FORM
    ------------------------------------------ */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      form.querySelectorAll(".tooltip").forEach(t => t.remove());
      inputs.forEach(i => i.classList.remove("border-red", "border-green"));

      let valid = true;
      let firstError = null;

      /* Validate Required */
      inputs.forEach(el => {
        if (el.hasAttribute("required") && !el.value.trim()) {
          el.classList.add("border-red");
          showTooltip(el, "Không được để trống");
          valid = false;
          if (!firstError) firstError = el;
        }
      });

      /* Validate CCCD 12 số */
      if (!/^\d{12}$/.test(cccd.value.trim())) {
        cccd.classList.add("border-red");
        showTooltip(cccd, "CCCD phải gồm đúng 12 số");
        valid = false;
        if (!firstError) firstError = cccd;
      }

      /* Validate số điện thoại */
      const phone = phoneField.value.trim();
      if (!/^0\d{9}$/.test(phone)) {
        phoneField.classList.add("border-red");
        showTooltip(phoneField, "Số điện thoại phải gồm 10 số và bắt đầu bằng 0");
        valid = false;
        if (!firstError) firstError = phoneField;
      }

      /* Validate email */
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const emailField = document.getElementById("email");

      if (!emailRegex.test(emailField.value.trim())) {
        emailField.classList.add("border-red");
        showTooltip(emailField, "Email không hợp lệ");
        valid = false;
        if (!firstError) firstError = emailField;
      }

      if (!valid) {
        firstError.scrollIntoView({ behavior: "smooth", block: "center" });
        firstError.focus();
        return;
      }

      submitBtn.disabled = true;
      const oldHTML = submitBtn.innerHTML;
      submitBtn.innerHTML = `<span class="spinner"></span>`;

      try {

        // Giữ số 0 đầu CCCD bằng cách thêm dấu '
        const cccdRaw = cccd.value.trim();
        const cccdSafe = "'" + cccdRaw;

        // Format ngày dd/MM/yyyy
        function fmt(d) {
          if (!d) return "";
          const dt = new Date(d);
          return dt.toLocaleDateString("vi-VN"); 
        }

        const payload = {
          manv: manv.value.trim(),
          hodem: hodem.value.trim(),
          ten: ten.value.trim(),
          hoten: hoten.value.trim(),

          gioitinh: document.getElementById("gioitinh").value,
          
          cccd: cccdSafe,
          ngaycap: fmt(document.getElementById("ngaycap").value),
          noicap: document.getElementById("noicap").value,

          ngaysinh: fmt(document.getElementById("ngaysinh")?.value),

          nhanviec: fmt(document.getElementById("nhanviec")?.value || ""),
          nhanviechd: fmt(document.getElementById("nhanviechd")?.value || ""),

          chucvu: document.getElementById("chucvu")?.value.trim(),
          phongban: document.getElementById("phongban")?.value.trim(),

          dienthoai: phoneField.value.trim(),
          email: emailField.value.trim(),

          tinhtrang: "Đang làm việc",

          thuongtru: document.getElementById("thuongtru")?.value.trim(),
          tamtru: document.getElementById("tamtru")?.value.trim(),
          tinh: document.getElementById("tinh")?.value.trim(),
          huyen: document.getElementById("huyen")?.value.trim(),

          mst: document.getElementById("mst")?.value.trim(),
          bhxh: document.getElementById("bhxh")?.value.trim(),

          hocvan: document.getElementById("hocvan")?.value.trim(),
          chuyenmon: document.getElementById("chuyenmon")?.value.trim()
        };

        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let json;

        try { json = JSON.parse(text); }
        catch { json = { status: res.ok ? "success" : "error", raw: text }; }

        if (!res.ok || json.status !== "success") {
          alert("Lỗi gửi dữ liệu:\n" + text);
          submitBtn.disabled = false;
          submitBtn.innerHTML = oldHTML;
          return;
        }

        popup.style.display = "flex";
        setTimeout(() => popup.style.display = "none", 1500);

        form.reset();
        inputs.forEach(i => i.classList.remove("border-green"));

      } catch (err) {
        alert("Lỗi mạng/Worker:\n" + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = oldHTML;
      }

    });

  });

})();

</script>

</body>
</html>
